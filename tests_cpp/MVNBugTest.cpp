/*
 * MVNBugTest.cpp
 *
 *  Created on: May 11, 2021
 *      Author: toky
 */

#define BOOST_TEST_MODULE MVNBugTest
#include "testutils.h"

#include <boost/test/included/unit_test.hpp>
#include <PriorPoisson.h>
#include <MixtureMultiVariateNormal.h>


BOOST_AUTO_TEST_SUITE( test_suite_multivariate_normal_dataset )

BOOST_AUTO_TEST_CASE( test_multivariate_normal_bug )
{
	VERBOSE_LEVEL(2);
	/////////// R Script
	////    library("AntMAN", lib.loc = "/home/toky/yalenus/research/mixture/AntMan/AntMAN.Rinstall/")
    ////
    ////
    ////
	////    x1 <- cbind(rnorm(100, mean = 0, sd = 0.5), rnorm(100, mean = 0, sd = 0.5))
	////    x2 <- cbind(rnorm(100, mean = 3, sd = 0.5), rnorm(100, mean = 3, sd = 0.5))
	////    x3 <- cbind(rnorm(100, mean = 8, sd = 0.5), rnorm(100, mean = 8, sd = 0.5))
	////    x_combined <- rbind(x1, x2, x3)
	////    write.csv(x_combined, file ="xcombined.csv")
	////    plot(x_combined, main = "Scatterplot of the synthetic dataset")
	////    mixture_mvn_params <- AM_mix_hyperparams_multinorm(mu0 = rep(0,2),
	////                                                       ka0 = 1,
	////                                                       nu0 = 6,
	////                                                       Lam0 = 1*diag(2))
	////    mcmc_params<- AM_mcmc_parameters(niter=2000,
	////                                     burnin=500,
	////                                     thin=10,
	////                                     verbose=1,
	////                                     output = c("CI","K","M"))
	////    components_prior <- AM_mix_components_prior_pois(a=1,b=1)
	////    weights_prior <- AM_mix_weights_prior_gamma(a=1, b=1)
    ////
    ////
	////    set.seed(45)
	////    fit <- AM_mcmc_fit(
	////      y = as.matrix(x_combined),
	////      mix_kernel_hyperparams = mixture_mvn_params,
	////      mix_components_prior =components_prior,
	////      mix_weight_prior = weights_prior,
	////      mcmc_parameters = mcmc_params)
    ////
	////    plot(fit$K)
    ////
	////    plot(x_combined , col = fit$CI[[length(fit$CI)]] + 1 )



	static const arma::mat y_mvn = {
			{ 0.594650667878886,-0.401178661942205}, { 0.124275342291681,-0.064420153449155}, { -0.349188302683564,0.679131902854213}, { 0.561999538297167,0.265580642385514}, { 0.629089646031453,0.223372811354494}, { 0.646296142402247,-0.188684936525291}, { -0.355199662564616,0.794875071802577}, { 0.0267881187081359,0.049465711423038}, { 0.441804408157757,0.260074106639895}, { -0.189338102612276,0.211546996956579}, { -0.0202927716275509,0.13395346601074}, { -1.38613454704622,-0.227977238649628}, { -0.237994442151255,0.0109925166965126}, { -0.14225041481129,0.0187001677693688}, { -0.0439098037821555,-0.220429051626167}, { -0.0175501248977244,0.835669588119704}, { -0.198691197308259,0.279226472516284}, { -0.462711775836548,0.013865331612102}, { 0.417438158582945,0.321157629204768}, { 0.0551769987647396,-0.6550896692609}, { -0.615439296567225,0.364429568236997}, { 0.385548567266654,0.67153898852724}, { 0.16124059976716,-0.375732990667789}, { 0.0999562375762711,0.247165937338586}, { -0.00960589230389364,-0.26252562918164}, { -0.3341071065694,-0.756699162106447}, { 0.536565087173341,0.230017490536455}, { 0.463263820279543,0.513840989875281}, { -1.14907425780778,0.388943524541648}, { 0.47765535244818,-0.16449937582056}, { -0.336691064132863,0.619872858800637}, { 0.576412733138889,0.135683576742974}, { 0.0202827770681049,0.463648816366616}, { 0.0481091013726711,-0.313554972751102}, { -0.130107915210911,-0.0446681789416453}, { -0.0483469676280161,0.372624766986812}, { 1.08860744761272,-0.029046132977294}, { 0.365202996415601,0.240642920127317}, { -0.725959112192563,-0.637400826319003}, { -0.212318723007851,-0.488596980695965}, { 0.089622726903729,-0.634971980468618}, { -0.0108474382700434,0.863772574200661}, { -0.484687258329469,-0.661712226082961}, { 0.240481788890611,0.548054801275629}, { 0.166259323550466,0.0895643273429105}, { 0.33680946711414,-0.351693904059502}, { -0.0898600751968843,0.558250453466806}, { 0.856547247787314,0.0351151744382238}, { -0.257241614597986,-0.283089146813272}, { -0.182769899720467,0.653937179839083}, { 0.596412791709843,0.628346999904481}, { 0.229307930441293,-0.221493182811441}, { 1.18415225810042,0.0117941005215548}, { 0.295587885493956,-0.442384556011371}, { 0.393587681407949,-0.372929015402501}, { 0.260478621536021,-0.704404219965027}, { -0.19637305992299,-0.219031671424133}, { -0.967585957600254,0.660326405136471}, { 0.142385153616528,0.266424742296282}, { -0.235424894310981,-0.676244498655845}, { -0.323831270580512,-0.0643950008284212}, { -0.0432801466465779,0.22044465108359}, { -0.399993588822693,0.480466183534099}, { 0.984411711426664,-0.100952682779392}, { -0.413740859440196,-0.282035536838794}, { 0.402695392063223,0.357164234991723}, { -0.22090118652098,-0.159606801830279}, { 0.253031156007773,0.616555334185912}, { 0.545164302809124,0.478004660895539}, { -0.239051715274517,0.551368972483116}, { -0.907034525516919,-0.513934241837378}, { -0.554642168154664,-0.282238685981415}, { 0.143581038157663,0.00523510178116629}, { -1.10051145872121,-0.642828543174388}, { -0.0461236466575201,-0.0357009318572764}, { -0.574522499754369,-0.0162485991872069}, { -0.842841131945101,-0.699630156919473}, { -1.09667939720318,-0.234125057750621}, { 0.0979413518567398,-0.87373719815688}, { -0.873451735134722,-0.0511736655570626}, { 0.531721821650564,0.486845021176016}, { 0.239564165718168,0.722454743651694}, { -0.00186509775483935,-0.284144836245395}, { -0.713908412730701,-0.089987367653683}, { -0.0772575966429085,1.10481114073095}, { -0.532361327635966,0.166569720216517}, { -0.758695604855861,0.508395615563537}, { -0.435318992553303,0.29604602640368}, { 0.471345302051548,-0.537690076953397}, { 0.491087492429905,0.349924511790673}, { -0.256035261051326,-0.226731688139759}, { -0.440315722063977,-0.0390710129813313}, { -0.0104943134853153,-0.287482027768079}, { -0.840758607341504,0.755221244056859}, { -0.064931588270168,-1.00722662936561}, { 0.117240417630508,-0.373914418846167}, { -0.475923886701207,-0.661879932190233}, { 0.549185642447064,0.241382285918353}, { -0.7735030115952,-0.0201500385701022}, { 0.0333379235003301,-0.440790110510314}, { 3.106149545453,3.12707011101859}, { 3.14562477333574,2.24497083053572}, { 3.02674436087103,2.72579314549043}, { 3.25176346186115,2.34487531972382}, { 2.88579388589122,2.94312369459885}, { 2.92091913947959,3.49928464199619}, { 2.87919914191829,2.994842064976}, { 2.74709465203901,3.73211421523252}, { 3.31459992337821,3.75425920687431}, { 2.52422951702778,3.27829812803104}, { 2.73387030537008,3.2690541403829}, { 3.25918403399353,2.83676720544761}, { 2.78388539364113,3.05683855882622}, { 2.26114509626455,2.74865012754643}, { 2.96111447406935,3.23036079366459}, { 2.69080415657266,3.91468073443449}, { 3.13029193236217,3.9839773279806}, { 3.43756325117847,2.98123547107549}, { 2.00620308875115,3.80439664931539}, { 3.03059570244406,2.65085573607115}, { 2.88253059213817,2.74054435327011}, { 1.93104619059117,3.89876099290894}, { 3.91595269968221,2.96571491544134}, { 3.63612398102511,2.41712955808546}, { 2.8135329465072,3.40249670933966}, { 3.83507725834549,3.47036172052823}, { 3.3488872021193,3.04319196670008}, { 2.81919392748036,2.87684404774617}, { 2.48285428431325,3.08172498347783}, { 2.44884622318229,3.43037385841792}, { 3.40359303120079,3.81247835675068}, { 3.23413156021004,3.38983780201919}, { 3.0231246525981,2.85212502432749}, { 2.7585001717603,3.37340797202953}, { 2.77088157228303,3.43798052931112}, { 2.85908174222902,3.05644790297498}, { 4.06796832660312,3.36174561954069}, { 3.78557669113022,2.90187552268849}, { 2.64994331654985,2.07665882490031}, { 3.10345320116476,2.61234350456843}, { 4.04805411603524,2.39150062802183}, { 2.78591473949987,3.21570779929177}, { 2.74558607213611,3.56780142607577}, { 2.56425950514419,3.13122623140311}, { 3.2044159744137,2.67193894772454}, { 2.7614462255747,2.68826201674223}, { 3.30847170051117,2.8998526239801}, { 3.28139729394166,3.8400924286603}, { 3.53715736091949,3.26421672168489}, { 2.77873128870502,2.91312085032152}, { 2.291328830105,3.08745517959315}, { 3.40908978064425,2.69105197773676}, { 3.37498369677352,2.01940336357737}, { 3.75742336411045,3.87940800266022}, { 3.05855517820059,2.32661399932056}, { 2.08413754285337,2.82863570579343}, { 2.70497846778031,3.65150720923193}, { 3.05665825738306,4.00285941192298}, { 2.77940290214852,3.60570582886766}, { 2.400508473016,3.08025701897518}, { 3.53764299456308,3.37584956755849}, { 2.82406898108833,3.13447951051871}, { 2.86750798346382,3.23011683604422}, { 3.90693403277549,3.39959144328099}, { 2.28454829761309,3.19775280764079}, { 4.14775860514329,2.71272000952576}, { 2.73489492980846,3.00860066155382}, { 3.9628924115412,3.06349527948612}, { 2.88220278368485,1.67212890464851}, { 3.66042670703667,3.68493859253875}, { 2.75555470229557,3.4822533221212}, { 3.26539363171129,2.82135679709529}, { 2.87603820270317,3.1378298394146}, { 3.08088032819611,2.71487470971985}, { 1.72866085362423,2.53795571646755}, { 2.95640353338356,2.68605846722019}, { 2.96226860268866,3.15558578731641}, { 3.052443512137,2.87696762352363}, { 3.69752287598891,3.09704162526096}, { 3.51021283411928,2.47799387889273}, { 3.1305440064832,2.15476243494788}, { 3.16882410313479,3.33017125398745}, { 3.2103209143981,1.94261927198477}, { 3.05679342915908,3.39836105146145}, { 3.38446602397564,3.12778749894834}, { 2.42404242948125,3.1415854019628}, { 2.37144991842968,2.48513630297626}, { 3.59128976749909,3.10099054194509}, { 2.60818292256452,2.77927589819303}, { 2.71048939383622,3.23286720245667}, { 3.28138517974152,2.81760471647038}, { 1.91480732712919,3.07855490764345}, { 3.24367432411042,3.00103367308572}, { 3.52768926401671,2.5297249529252}, { 3.15423515236007,3.18547996011794}, { 3.30010367959801,1.71613740911442}, { 3.19136296493809,3.10161256309527}, { 2.91612120002865,2.90758714354094}, { 3.23664008618189,2.84316186564306}, { 2.56623010605574,3.74522176734013}, { 8.309182233964,7.90316090422529}, { 7.619814869239,8.66609966639078}, { 7.5500614239449,8.13559427813763}, { 7.42568464786426,8.31072228513029}, { 9.14301470648582,9.09096321188605}, { 8.09991350224632,8.4164786651525}, { 8.75433787685077,7.96101457220321}, { 8.44214432363385,8.31411144382033}, { 8.24416338026217,8.30220315189992}, { 7.55128922187003,8.10537063198769}, { 8.40126928593046,7.95470588952089}, { 8.07897433241757,7.87864097060621}, { 7.51301748396559,8.57243578228982}, { 8.55896487806221,8.00489768100609}, { 8.69125086529204,8.01083495060904}, { 8.40098658350485,8.25231788904324}, { 7.03035577115191,7.14704374756795}, { 8.67336693976618,8.01042570586585}, { 8.15770922588376,7.88048944584014}, { 7.32244601088016,7.38290196097549}, { 8.2663925419442,8.60656734850289}, { 7.9279532001758,7.56134950031676}, { 8.15268902667544,8.36990156521215}, { 7.40235794943613,8.90162031319428}, { 7.96646439335156,6.96124980218555}, { 8.62965006890586,8.80170288384678}, { 8.26337798937384,8.54603341815055}, { 8.11329948496888,7.67901426482432}, { 8.82975930869184,7.76561208964799}, { 7.39492367846039,8.44337546278772}, { 8.21260071251544,7.79171501924862}, { 8.0799034016364,7.98452603220442}, { 8.07377600046832,8.27992355597483}, { 8.22303724938208,7.34899736989781}, { 6.91315342718552,7.7615700564785}, { 8.09486237029816,8.55258470628322}, { 7.65924331872719,7.87790309222118}, { 8.34147701279609,8.27644966944956}, { 7.72457037499841,7.87130107935271}, { 7.56642629373758,8.43270891091004}, { 8.49816334454229,6.71357268030874}, { 8.20361692415863,8.20545008379191}, { 7.78353846834048,7.23116214241349}, { 7.7227496523057,7.64784794313708}, { 8.57681966525828,6.98107969819723}, { 8.32064010021585,8.23196840748367}, { 8.57642761286848,7.83093913115232}, { 8.0284570663331,9.1806080315969}, { 8.08526972483886,7.87232344500775}, { 7.88050418283391,7.65308883327808}, { 7.69385282516362,7.78300523348357}, { 7.95099601097187,7.24345549069827}, { 8.17871115885547,8.74531050875481}, { 8.17116454043598,8.56604069298115}, { 7.57963112750898,7.98269069860063}, { 8.74603142312293,8.04885000590891}, { 7.22451474202692,7.99191804337294}, { 8.88462010315442,8.16192700056759}, { 7.67322134807324,8.09663050036779}, { 7.64379218582753,8.35590676974998}, { 8.26604229756339,8.34041379156009}, { 7.49219796230452,6.91531361207115}, { 7.34564675047002,7.22861322397684}, { 9.10647881410647,8.23989949889972}, { 7.6318050039825,8.38559144183426}, { 7.93865488692856,8.48209033931546}, { 8.33967199691503,7.75311487368332}, { 7.73551491609071,7.42797846659761}, { 7.32937196457299,8.3070355879884}, { 7.64409334078973,8.24214644871388}, { 8.48858406472489,8.14740022719668}, { 8.22663123308913,7.35049204547007}, { 7.73012973766959,8.50869658330771}, { 8.39206435853756,7.80097621298948}, { 8.42040095154252,7.11418693360668}, { 7.59962305056495,7.78026634746639}, { 8.47229986792953,8.19516485637067}, { 7.62771567506875,6.71105373643084}, { 8.28338631766024,8.11012723058877}, { 7.44526772571211,7.5514588934439}, { 8.74973319407434,7.75918660134549}, { 8.42615387281488,8.19813447277227}, { 8.14650698913974,8.52151248002846}, { 8.14073679853333,7.49005408964965}, { 8.1754807770603,6.81370337737915}, { 8.15365030176352,7.40566204259027}, { 7.7891594712687,6.77453725681602}, { 8.07302797357986,7.4234550550203}, { 9.15847700066361,7.18034318653829}, { 8.2260132953218,8.2616368647194}, { 7.6409973115707,7.30741199354175}, { 8.65467317258181,7.80390244039566}, { 8.55514939984258,7.67663139341102}, { 8.38644233129389,8.27722907356244}, { 7.0146851950773,8.06603988949566}, { 8.73290513797775,7.83502878201121}, { 7.89157583920137,7.91133137001597}, { 8.191149492724,7.72634828799032}, { 7.58695495400392,7.87538650050049}, { 6.63926247301465,7.89339065925668}
	};

	cluster_indices_t initial_clustering  = arma::regspace<arma::ivec>(0,  y_mvn.n_rows -1);


	{
		AntMANLogger logger (std::vector<std::string>(), (1000 - 500) / 10 );
		PriorPoisson *prior = new PriorPoisson(poisson_gamma_h_param_t(1,1,0.00001),poisson_gamma_q_param_t(1,1));
		MixtureMultivariateNormal * mixture = new MixtureMultivariateNormal ((arma::vec){0,0}, 1, 6, arma::eye(2,2));
		mixture->fit(y_mvn , initial_clustering, false, prior , 2000 ,0 ,10 , false , &logger);
		COUT_STREAM << ( getString (logger)) ;
	}

	{
		AntMANLogger logger (std::vector<std::string>(), (1000 - 500) / 10 );
		PriorPoisson *prior = new PriorPoisson(poisson_gamma_h_param_t(1,1,0.00001),poisson_gamma_q_param_t(1,1));
		MixtureMultivariateNormal * mixture = new MixtureMultivariateNormal ((arma::vec){0,0}, 1, 6, arma::eye(2,2));
		mixture->fit(y_mvn , initial_clustering, false, prior , 2000 ,0 ,10 , false , &logger);
		COUT_STREAM << ( getString (logger)) ;
	}

	{
		AntMANLogger logger (std::vector<std::string>(), (1000 - 500) / 10 );
		PriorPoisson *prior = new PriorPoisson(poisson_gamma_h_param_t(1,1,0.00001),poisson_gamma_q_param_t(1,1));
		MixtureMultivariateNormal * mixture = new MixtureMultivariateNormal ((arma::vec){0,0}, 1, 6, arma::eye(2,2));
		mixture->fit(y_mvn , initial_clustering, false, prior , 2000 ,0 ,10 , false , &logger);
		COUT_STREAM << ( getString (logger)) ;
	}

	}


BOOST_AUTO_TEST_SUITE_END()




